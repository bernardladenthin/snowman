//compressor: http://gpbmike.github.io/refresh-sf/
/**
 * snowman-html5-canvasapi- HTML5 canvas api for snowman.
 * https://github.com/bernardladenthin/snowman
 *
 * Copyright (C) 2013 Bernard Ladenthin <bernard.ladenthin@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 */
function getSnowmanHtml5Canvasapi(){"use strict";var e={currentParallelRequests:0,maxParallelRequests:3,bDebugLog:!1,data:{canvas:!1,liveviewLastSeconds:0,liveviewLastMillis:0}};return e.debugLog=function(t){e.bDebugLog&&console.log(t)},e.enableDebugLog=function(){e.bDebugLog=!0},e.disableDebugLog=function(){e.bDebugLog=!1},e.getCanvas=function(){return e.data.canvas},e.setCanvas=function(t){e.data.canvas=t},e.getMaxParallelRequests=function(){return e.maxParallelRequests},e.setMaxParallelRequests=function(t){e.maxParallelRequests=t},e.acquireRequestSlot=function(){return e.maxParallelRequests>e.currentParallelRequests?(e.currentParallelRequests+=1,!0):!1},e.permitRequestSlot=function(){e.currentParallelRequests-=1},e.parseResponseHeaders=function(e){var t,a,s,n,l,o,i;if(t={},a=e.split("\r\n"),!e)return t;for(i=0;i<a.length;i+=1)s=a[i],n=s.indexOf(": "),n>0&&(l=s.substring(0,n),o=s.substring(n+2),t[l]=o);return t},e.initCanvas=function(){var t,a,s,n=e.getCanvas();n[0].getContext&&(t=640,a=360,n[0].width=t,n[0].height=a,s=n[0].getContext("2d"),s.moveTo(0,0),s.lineTo(t,a),s.stroke(),s.fillStyle="black",s.strokeRect(0,0,t,a))},e.fetchImage=function(t,a,s){var n,l,o;e.acquireRequestSlot()!==!1&&(n=new Date,l=n.getTime(),o="name="+t+"&t="+l+"&base64=true",s&&s.length>0&&(o+=s),jQuery.ajax({type:"GET",url:a,data:o,dataType:"text",success:e.successCb,error:e.errorCb,complete:e.completeCb}))},e.successCb=function(t,a,s){var n,l,o,i,u,g,r;e.debugLog("call snowmanHtml5Canvasapi.successCb"),e.debugLog(a),e.debugLog(s),e.debugLog(s.getAllResponseHeaders()),n=e.parseResponseHeaders(s.getAllResponseHeaders()),e.debugLog(n),l=parseInt(n["snowman-timeseconds"],10),o=parseInt(n["snowman-timemillis"],10),e.debugLog(l),e.debugLog(o),e.debugLog(e.data.liveviewLastSeconds),e.debugLog(e.data.liveviewLastMillis),i=!1,e.data.liveviewLastSeconds<l?i=!0:e.data.liveviewLastSeconds===l&&e.data.liveviewLastMillis<o?i=!0:(isNaN(l)||isNaN(o))&&(l=o=0,i=!0),i?(e.data.liveviewLastSeconds=l,e.data.liveviewLastMillis=o,e.debugLog("hit"),r=e.getCanvas(),r[0].getContext&&(u=new Image,u.src="data:image/jpeg;base64,"+t,u.onload=function(){r[0].width=u.naturalWidth,r[0].height=u.naturalHeight,g=r[0].getContext("2d"),g.drawImage(u,0,0)})):e.debugLog("miss")},e.errorCb=function(t,a,s){e.debugLog("call liveviewErrorCb"),e.debugLog(t),e.debugLog(a),e.debugLog(s)},e.completeCb=function(t,a){e.permitRequestSlot(),e.debugLog("call liveviewCompleteCb"),e.debugLog(t),e.debugLog(a)},e}
